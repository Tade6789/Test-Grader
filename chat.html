<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>24/7 Support Chat - Test Grader</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .login-container { max-width: 500px; margin: 50px auto; }
        .login-box {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.2);
            text-align: center;
        }
        .login-box h1 { color: #4c3f91; margin-bottom: 1rem; font-size: 1.8rem; }
        .login-box p { color: #666; margin-bottom: 2rem; }
        .outlook-btn {
            background: linear-gradient(135deg, #0078d4, #107c10);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s;
        }
        .outlook-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,120,212,0.3);
        }
        .container { max-width: 700px; margin: 0 auto; }
        header {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            text-align: center;
        }
        header h1 { color: #4c3f91; font-size: 2rem; margin-bottom: 0.5rem; }
        .status {
            display: inline-block;
            background: #4caf50;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            margin-top: 0.5rem;
        }
        .status.online::before { content: "‚óè "; }
        .chat-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 600px;
        }
        .chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            text-align: center;
        }
        .chat-header h2 { font-size: 1.3rem; margin-bottom: 0.3rem; }
        .chat-header p { font-size: 0.9rem; opacity: 0.9; }
        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
            background: #f9f9f9;
        }
        .message {
            margin-bottom: 1rem;
            display: flex;
            animation: slideIn 0.3s ease-in;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .message.user {
            justify-content: flex-end;
        }
        .message-bubble {
            max-width: 70%;
            padding: 0.8rem 1.2rem;
            border-radius: 10px;
            word-wrap: break-word;
        }
        .message.user .message-bubble {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 10px 0 10px 10px;
        }
        .message.bot .message-bubble {
            background: #e8e8e8;
            color: #333;
            border-radius: 0 10px 10px 10px;
        }
        .message-time {
            font-size: 0.75rem;
            color: #999;
            margin-top: 0.3rem;
            padding: 0 0.5rem;
        }
        .input-area {
            padding: 1.5rem;
            background: white;
            border-top: 1px solid #ddd;
            display: flex;
            gap: 0.5rem;
        }
        .input-area input {
            flex: 1;
            padding: 0.8rem;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }
        .input-area input:focus {
            outline: none;
            border-color: #667eea;
        }
        .input-area button {
            padding: 0.8rem 1.5rem;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 5px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        .input-area button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(102,126,234,0.3);
        }
        .nav-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            justify-content: center;
            flex-wrap: wrap;
        }
        .nav-buttons a {
            padding: 0.8rem 1.5rem;
            border: 2px solid white;
            color: white;
            border-radius: 5px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s;
        }
        .nav-buttons a:hover { background: rgba(255,255,255,0.1); }
        .info-box {
            background: rgba(255,255,255,0.1);
            color: white;
            padding: 1rem;
            border-radius: 5px;
            margin-top: 1.5rem;
            text-align: center;
        }
        .info-box strong { display: block; margin-bottom: 0.5rem; }
    </style>
</head>
<body>
    <div id="loginContainer" class="login-container" style="display: none;">
        <div class="login-box">
            <h1>üí¨ 24/7 Support Chat</h1>
            <p>Sign in to access 24/7 support</p>
            <div style="margin-bottom: 1rem;">
                <input type="email" id="loginEmail" placeholder="Enter your email" style="width: 100%; padding: 0.8rem; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem; margin-bottom: 0.8rem;">
                <input type="password" id="loginPassword" placeholder="Enter your password" style="width: 100%; padding: 0.8rem; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem;">
            </div>
            <button class="outlook-btn" onclick="loginToChat()">
                üîí Sign In to Chat
            </button>
            <p style="margin-top: 1rem; font-size: 0.9rem; color: #999;">
                Only for custom account holders (Classic/Pro plans)
            </p>
            <div id="loginError" style="color: #e94560; margin-top: 1rem; display: none;"></div>
        </div>
    </div>

    <div class="container" id="chatContainer" style="display: none;">
        <header>
            <h1>üí¨ 24/7 Support Chat</h1>
            <p>Get help anytime with our support team</p>
            <div class="status online">Online - Ready to Help</div>
            <button onclick="logout()" style="background: #e94560; color: white; border: none; padding: 0.5rem 1rem; border-radius: 5px; cursor: pointer; margin-top: 1rem;">Logout</button>
        </header>

        <div class="chat-container">
            <div class="chat-header">
                <h2>Support Team</h2>
                <p>Average response time: 2 minutes</p>
            </div>

            <div class="messages" id="messages">
                <div class="message bot">
                    <div>
                        <div class="message-bubble">üëã Hello! Welcome to Test Grader Support. How can we help you today?</div>
                        <div class="message-time">Just now</div>
                    </div>
                </div>
            </div>

            <div class="input-area">
                <input type="text" id="messageInput" placeholder="Type your message..." autocomplete="off">
                <button onclick="sendMessage()">Send</button>
            </div>
        </div>

        <div class="nav-buttons">
            <a href="/teacher">‚Üê Back to Console</a>
            <a href="/student">üë• Add Student</a>
            <a href="/account">üë§ My Profile</a>
        </div>

        <div class="info-box">
            <strong>üí° Quick Help</strong>
            Popular topics: Grading ‚Ä¢ Payments ‚Ä¢ Account Settings ‚Ä¢ Technical Issues
        </div>
    </div>

    <script>
        const messagesDiv = document.getElementById('messages');
        const messageInput = document.getElementById('messageInput');
        const loginContainer = document.getElementById('loginContainer');
        const chatContainer = document.getElementById('chatContainer');

        async function loginToChat() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');
            
            if (!email || !email.includes('@')) {
                errorDiv.textContent = 'Please enter a valid email address';
                errorDiv.style.display = 'block';
                return;
            }
            
            if (!password) {
                errorDiv.textContent = 'Please enter your password';
                errorDiv.style.display = 'block';
                return;
            }

            try {
                const response = await fetch('/api/chat/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();
                if (data.success) {
                    localStorage.setItem('userEmail', email);
                    errorDiv.style.display = 'none';
                    showChat();
                    loadMessages();
                } else {
                    errorDiv.textContent = data.error || 'Only custom account holders can access chat';
                    errorDiv.style.display = 'block';
                }
            } catch (error) {
                console.error('Login error:', error);
                errorDiv.textContent = 'Login failed. Please try again.';
                errorDiv.style.display = 'block';
            }
        }

        function showChat() {
            loginContainer.style.display = 'none';
            chatContainer.style.display = 'block';
        }

        function showLogin() {
            loginContainer.style.display = 'block';
            chatContainer.style.display = 'none';
        }

        async function loadMessages() {
            try {
                const response = await fetch('/api/chat/messages');
                if (response.ok) {
                    const data = await response.json();
                    messagesDiv.innerHTML = '';
                    data.messages.forEach(msg => {
                        addMessage(msg.message, msg.sender_type);
                    });
                }
            } catch (error) {
                console.error('Error loading messages:', error);
            }
        }

        const responses = [
            "Thanks for reaching out! Our support team will respond soon.",
            "We appreciate you contacting us!",
            "Your message has been received. We'll help you shortly.",
            "Is there anything else we can assist you with?",
            "Thanks for using Test Grader! üéì",
        ];

        async function sendMessage() {
            const text = messageInput.value.trim();
            if (!text) return;

            // Add user message
            addMessage(text, 'user');
            messageInput.value = '';

            try {
                const response = await fetch('/api/chat/send', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: text })
                });

                if (response.ok) {
                    const data = await response.json();
                    // Add support response after delay
                    setTimeout(() => {
                        const randomResponse = responses[Math.floor(Math.random() * responses.length)];
                        addMessage(randomResponse, 'support');
                    }, 1000);
                }
            } catch (error) {
                console.error('Error sending message:', error);
            }
        }

        function addMessage(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            messageDiv.innerHTML = `
                <div>
                    <div class="message-bubble">${escapeHtml(text)}</div>
                    <div class="message-time">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                </div>
            `;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function logout() {
            localStorage.removeItem('userEmail');
            await fetch('/api/logout', { method: 'POST' });
            showLogin();
            messagesDiv.innerHTML = '';
        }

        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        // Check if user is logged in on page load
        window.addEventListener('load', () => {
            const email = localStorage.getItem('userEmail');
            if (email) {
                showChat();
                loadMessages();
            } else {
                showLogin();
            }
        });
    </script>
</body>
</html>
